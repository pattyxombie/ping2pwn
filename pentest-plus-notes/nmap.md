# Nmap
- A versatile port scanner used for topology, host, service, and OS discovery and enum


### Nmap discovery scans
- Footprinting, what hosts are sitting on the network. Topology. Finding which devices are connected to the network

#### Discovery scan:
- ` nmap ip/cidr block`
  - Will send a ping with a TCP acknowledgement packet to ports 80 and 443, this will determine whether a host is there and present
- If host is there and detected nmap will then perform a port scan against that host
- Can be time consuming because of the number of ports it is checking
- Not stealthy, most IDS wll see this and block it!

#### Host Discovery Scan:
- ` nmap -sn ip/cidr block`
- the flag `-sn` will only do the host discovery part and not the ports, it will suppress the port scan
- also called a *ping* scan

#### List Scan:
- `sL` lists the IP addresses from the supplied target range(s) and performs a reverse-DNS query to discover any host names associated with those IP addresses
- more of a passive method, asking the dns record to do the lookup for you so not really touching the hosts

#### TCP SYN ping
- ` -PS <PortList>` probes specific ports from the given list using a TCP SYN packet instead of an ICMP packet to conduct the ping
- some networks block ICMP, so would show as `host not found` or no response
- Send out the SYN, we get back the SYN-ACK that tells us the host is alive, but then the client does not complete the handshake by sending the ACK packet. Do not send out the ACK to avoid revealing info of who we are

#### Sparse Scanning
- `--scan-delay <Time>` issues probes with significant delays to become stealthier and avoid detection by an IDS or IPS
- scanning over a delayed time can make detection harder, this is more stealthy!

#### Scan Timing
- `-Tn` issues probes with a timing pattern, with n being the pattern to utilize 
- 0 is the slowest and 5 is the fastest, 3 is in the middle
- helps to evade detection

#### TCP Idle Scan
- ` -sI` makes it appear that another machine (a zombie) started the scan to hide the true identity of the scanning machine
- stealthy, redirection

#### Fragmentation
- `f` or `--mtu`, a technique that splits the TCP header of each probe between multiple IP datagrams to make it harder for IDS and IPS detection


#### Send results to file
- Interactive (default) to screen
- Normal ` -oN` to file
- `-oX` creates XML file
- `-oG` creates a Grepable file, helpful for very large data sets

Exam tips
- be comfortable with scanning hosts, understand the concept of nmap and what to use it for




### Nmap port scans

#### Service Discovery
- Helps determine which network services and OS are in use by a target
- Can take minutes to hours to complete
- IDS/IPS can detect MOST type of nmap scanning (ones that are well configured)

#### TCP SYN
- `sS` conducts a half-open scan by sending a SYN packet to id the port state w/o an ACK packet afterwards
- initiates the 3 way handshake, not finishing it. SYN, SYN-ACK, but no ACK
- half-open scan

#### TCP Connect
- `-sT` conducts a three-way handshake scan by sending a SYN packet to identify the port state and then sending an ACK packet once the SYN-ACK is received
- completes the handshake
- sometimes network cards don't support half open scans, only certain network cards can and you need root/admin access
- you may not have rights to do TCP SYN, so this is when you would have to do the full 3 way handshake

#### Null Scan
- `-sN` conducts a scan by sending a packet with the header bit set to zero
- null, no info
- looks abnormal, so most IDS/IPS will notice this

#### FIN Scan
- `-sF` conducts a scan by sending an unexpected FIN packet
- FIN packets are used to end a communication session in TCP/IP
- will flag for IDS IPS

  #### Xmas Scan
  - `-sX` confucts a scan by sending a packet with the `FIN`,`PSH`, and `URG` flags set to on or one
  - looks like a XMAS tree in logs and intrusion detection, surefire way to get caught
  - helps as a test to see if you are caught, if they don't catch this they aren't paying attention
 
#### UDP Scan
- `-sU` conducts a scan by sending a UDP packet to the target and waiting for a response or timeout
- because UDP doesn't have ack, we will just see response or timeouts
- No response (open/filtered port) or icmp portunreachable (closed)
- this is more stealthy

#### Port Range
- `-p` conducts a scan by targetting the specified ports instead of the default of the 1000 most commonly used ports
- not very stealthy or timely
- scan for the ports you want to investigate (port 80, 21, etc)

These techniques can be combined to be more stealthy, looking at only specific ports, changing the timing, etc.

### Port States

#### Open
- When an application on the host is ready to accept connections
- ex. port 80 should be open for web servers, port 23 should not be open if not using telnet

#### Closed
- The port responds to probes by sending a RST (reset) packet, no app is available to accept connections
- web server that is not running telnet will not have port 23 open, it will send back a RST packet and you will know there is not telnet running

#### Filtered
- nmap cannot probe the port, usually due to firewall
  
#### Unfiltered
- nmap can probe the port but cannot determine if it is open or closed
- not being blocked
- not common to find unfiltered

#### Open-Filtered
- When nmap cannot determine if port is open OR filtered
- one or the other, udp or ip-protocol scans it will come back this way. SYN scans should tell you if it is one or the other.

#### Closed-Filtered
- Cannot determine if port is closed OR filtered when conducting TCP idle scan `tI`

An open port indicates a host that is vulnerable to inbound connection. Helps id the attack surface of the network.

### Nmap fingerprinting
- identify what type of device we are looking at: os, apps, resources

#### CPE (Common Platform Enum)
- Scheme for identifying hardware devices, OS, and apps developed by MITRE corp
- database of diff fingerprint sigs; nmap compares response it is getting with the SYN-ACK

#### intensive port scanning
- `nmap -sV ip` get basic versioning info
- `nmap -A ip` will gather even more data; protocols, app name and version, OS and version, Host name, Device type; ports will show up with their states, and the service running on it, as well as the fingerprinting strings and if it is able to id it, network addresses (MACs)
- `-O` will gather the OS versioning

  
  


# nmap options
You can combine the options to gather what you want
ex. `nmap -sS -sV -O ip -oG output.txt` (syn scan, service versioning, os versioning, outputs to grepable txt file)

Exam tips: 
scan inside home network, scan scanme.nmap.org
know the syntax options
read the outputs to understand vulns


## Using Nmap




## Nmap Scripting Engine, NSE
- Scripts are written in the *Lua* scripting language that can be used to carry out detailed probes
- Automates info gathering and vuln discovering, using scripts
- OS detection and platform enum
- Windows user acct discovery
- Iding logged-on win users
- Basic vuln detection
- Get HTTP data and id apps
- geolocation to traceroute probes
- nmap.org has lots of premade scripts!

- head `/usr/share/nmap/scripts/script.db` location to see the top 10
- this dir hosts a wide range of scripts that come with the tool
- `grep auth ` for the authentication scripts

Scanning example
- `sudo nmap -sS scanme.nmap.org` runs the tcp syn (half open scan), will show 31337 is open which is a backdoor for Elite service
- `nmap -sV --script-vuln scanme.nmap.org` to check for known vulns, it will show all the CVEs associated with the different ports
